---
title: "Value at Risk"
output: html_document
date: "2024-07-21"
---


Compute historical simulation VaR (qtl: 99%, holding: 1month, lookback: 10y) for a portfolio with 10y Zero Coupon (ZC) bond and 5y ZC bond (each with a face: USD 1m). Also, compute the contribution to total VaR of each bond


```{r}
require(ggplot2)
require(zoo)
require(reshape2)
```


```{r}
# load checkpoint
load("dataframes/reg.Rda")
```


# compute bond prices
```{r}
face.val <- 1e6 # face value
df$P5 <- face.val / (1+df$DGS5/100)^5
df$P10 <- face.val / (1+df$DGS10/100)^10
```


```{r}
# plot bond prices
df.melt <- melt(df, id="DATE", measure.vars=c("P5", "P10"), variable.name="BOND", value.name="PRICE")
ggplot(df.melt, aes(x=DATE, y=PRICE, color=BOND)) + geom_line()
```


# compute $ returns
```{r}
df$R5 <- c(diff(df$P5), NA)
df$R10 <- c(diff(df$P10), NA)

# compute $ portfolio returns
df$R.Portfolio <- df$R5 + df$R10

ggplot(df, aes(x=DATE, y=cumsum(R.Portfolio))) + geom_line()

```


```{r}
# plot returns
df.melt <- melt(df, id="DATE", measure.vars=c("R5", "R10", "R.Portfolio"), variable.name="INSTRUMENT", value.name="RETURN")
ggplot(df.melt, aes(x=DATE, y=RETURN, color=INSTRUMENT)) + geom_line(alpha=0.5)

```




# cumulate monthly return
```{r}
# define lookback period
lookback <- 10
start_date <- as.Date(format(df$DATE[length(df$DATE)]- 365*lookback, "%Y-%m-01")) # "2014-07-01"
end_date <- as.Date(format(df$DATE[length(df$DATE)], "%Y-%m-01"))-1 # "2024-06-30"
tail(df)
```


assumption: calendar month is ok, could change to 30 day periods to have equal length!
assumption: take non-overlapping time windows to get return observations that are less correlated


```{r}

# Aggregate $ returns by year_month
df$year_month <- format(df$DATE, "%Y-%m")
df.lookback <- df[(df$DATE>=start_date) & (df$DATE<=end_date),]
R.Portfolio.monthly <- aggregate(R.Portfolio ~ year_month, df.lookback, sum)
```


# compute VaR
```{r}
var.portfolio <- quantile(R.Portfolio.monthly$R.Portfolio, 0.01)
paste("in 99% of calendar months, the portfolio value would change no more than VaR =", var.portfolio, "$")
```

```{r}
# plot distribution with VaR
hist(R.Portfolio.monthly$R.Portfolio, 
     main="Histogram of Monthly Portfolio Returns",
     xlab="Monthly Portfolio Return in $",
     probability=F
)
abline(v=var.portfolio, col="red")
text(var.portfolio*0.7,25, paste0("VaR at 99%", "\n", round(var.portfolio), " USD"), col="red")

```


# Also, compute the contribution to total VaR of each bond
- marginal VaR
- component VaR
```{r}
# R5.monthly <- aggregate(R5 ~ year_month, df.lookback, sum)
# var5 <- quantile(R5.monthly$R5, 0.01)
# 
# R10.monthly <- aggregate(R10 ~ year_month, df.lookback, sum)
# var10 <- quantile(R10.monthly$R10, 0.01)

# var5+var10
# var.vector <- c(var5[[1]], var10[[1]])
# sqrt(t(var.vector) %*% cor(cbind(R5.monthly$R5, R10.monthly$R10)) %*% (var.vector))
```
